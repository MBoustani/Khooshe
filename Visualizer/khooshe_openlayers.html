<html>
<head>
<title>Memex GeoParser</title>

<link rel="stylesheet" href="static/css/bootstrap.css" rel="stylesheet" />

<script src="static/js/jquery-1.11.1.min.js"></script>
<script src="static/js/bootstrap.min.js"></script>
<script src="static/js/ol.js"></script>
<script src="static/js/jquery.csv.js"></script>

</head>
<body>
  <div id='map'></div>

  <script type="text/javascript">
			var layer = new ol.layer.Tile(
					{
						source : new ol.source.XYZ(
								{
									url : 'http://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png',
									attributions : [ new ol.Attribution(
											{
												html : [ '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="http://cartodb.com/attributions">CartoDB</a>' ]
											}) ]
								})
					});

			var view = new ol.View({
				center : ol.proj.transform([ -98.5, 39.76 ], 'EPSG:4326', 'EPSG:3857'),
				zoom : 2
			});

			map = new ol.Map({
				layers : [ layer ],
				target : 'map',
				view : view
			});

			//Checks if zoom level is changed and logs zoom levels
			map.getView().on('change:resolution', function() {
				console.log(":::: " + map.getView().getZoom())
			});
			
			var dataPointsAll={}
			/**
			 * Adjust size array within limits of min and max size
			**/
			var adjust = function(dataPoints){
				console.log(dataPoints.map(function(point){return point.label;}) )
				//define max and min bubble size
				var minSize = 4
				var maxSize = 50
				var maxMinDelta = maxSize - minSize
				//get maximum sized point
				maxIpSize = Math.max.apply(Math,dataPoints.map(function(point){return point.label;}))
				
				for (var i in dataPoints){
					dataPoints[i].label = minSize + (maxMinDelta * (dataPoints[i].label / maxIpSize) ) 
				}
				console.log(dataPoints.map(function(point){return point.label;}) )
				return dataPoints
			}
			
			var drawPoints = function(dataPoints) {

				if (!dataPoints.length || dataPoints.length == 0) {
					return;
				}

				var icon_feature = [];
				dataPoints = adjust(dataPoints)
				for ( var i in dataPoints) {
					var point = dataPoints[i];
					var iconFeature = new ol.Feature({
						geometry : new ol.geom.Point([ parseFloat(point.longitude), parseFloat(point.latitude) ]).transform(
								'EPSG:4326', 'EPSG:3857')
						, name : i
					});
					var ccl = new ol.style.Circle({
						radius : point.label,
						fill : new ol.style.Fill({
							color : 'red'
						}),
						stroke : new ol.style.Stroke({
							color : 'silver',
							width : 1
					})})
					ccl.setOpacity(0.5)
					var iconStyle = new ol.style.Style({
						image : ccl
						
					});

					iconFeature.setStyle(iconStyle);
					icon_feature.push(iconFeature)
				}

				var vectorSource = new ol.source.Vector({
					features : icon_feature
				});

				var vectorLayer = new ol.layer.Vector({
					source : vectorSource
				});

				map.addLayer(vectorLayer);

			}
			$.ajax({
				type : "GET",
				url : "static/tiles/0/0.csv",
				dataType : "text",
				success : function(data) {
					drawPoints($.csv.toObjects(data));

				}
			});
		</script>
</body>
</html>
